// Generated by CoffeeScript 1.6.3
/*
# nodejs-express-mongoose-demo
# Copyright(c) 2013 Madhusudhan Srinivasa <madhums8@gmail.com>
# MIT Licensed
*/


(function() {
  var app, config, env, err, exports, express, externalConfig, fs, mongoose, p, path, pathToExternalConfig, port, _;

  express = require('express');

  fs = require('fs');

  p = require("commander");

  path = require("path");

  _ = require("underscore");

  p.version('0.0.1').option('-c, --config [VALUE]', 'path to config file').parse(process.argv);

  env = process.env.NODE_ENV || 'development';

  config = require('./config/config')[env];

  config.root = path.resolve(__dirname, "../");

  console.log("[server] config.root:" + config.root);

  if (p.config) {
    try {
      pathToExternalConfig = path.resolve(config.rootPath, p.config);
      console.log("[server] pathToExternalConfig:" + pathToExternalConfig);
      externalConfig = JSON.parse(fs.readFileSync(pathToExternalConfig));
      console.log("[server] externalConfig:%j", externalConfig);
      _.extend(config, externalConfig);
    } catch (_error) {
      err = _error;
      console.log("ERROR [server] fail to mixin externalConfig. " + err);
    }
  }

  mongoose = require('mongoose');

  mongoose.connect(config.db);

  if (env === 'development') {
    mongoose.set('debug', true);
  }

  require("./models/ticket");

  require("./models/worker");

  app = express();

  require('./config/express')(app, config);

  require('./config/routes')(app);

  port = process.env.PORT || 3456;

  app.listen(port);

  console.log("Ticketman app started on port " + port);

  exports = module.exports = app;

}).call(this);
