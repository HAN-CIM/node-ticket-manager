// Generated by CoffeeScript 1.6.3
/*
# test for ticket_worker
*/


(function() {
  var HOST, TicketManager, TicketWorker, WORKER_RECORD, assert, config, debuglog, request, setTicketWorker, should, ticketManager, ticketWorker;

  should = require("should");

  request = require("request");

  TicketWorker = require("../ticket_worker");

  TicketManager = require("../ticket_manager");

  debuglog = require("debug")("ticketman:test:ticket_worker_test");

  assert = require("assert");

  config = require("../config/config")['development'];

  WORKER_RECORD = null;

  ticketWorker = null;

  setTicketWorker = function(val) {
    return ticketWorker = val;
  };

  ticketManager = new TicketManager("test ticket_manager", "http://localhost:3456");

  HOST = "http://localhost:3456";

  describe("test ticket_worker", function() {
    before(function(done) {
      var options;
      options = {
        method: 'POST',
        url: "" + HOST + "/workers/new.json",
        auth: config.basicAuth,
        json: {
          name: "test#" + (Date.now().toString(36)),
          desc: "just for test"
        }
      };
      return request(options, function(err, res, body) {
        debuglog("err:" + err + ", res.statusCode:" + res.statusCode + ", body:%j", body);
        assert.equal(err, null);
        assert.equal(res.statusCode, 200);
        assert.notEqual(body, null);
        body.id = body._id;
        WORKER_RECORD = body;
        WORKER_RECORD.host = HOST;
        WORKER_RECORD.basicAuth = config.basicAuth;
        WORKER_RECORD.category = "sample";
        ticketWorker = new TicketWorker(WORKER_RECORD);
        return done();
      });
    });
    return describe("ticket_worker", function() {
      it("requireTicket when no pending ticket", function(done) {
        return ticketWorker.requireTicket(function(err, ticket) {
          should.not.exist(err);
          should.not.exist(ticket);
          return done();
        });
      });
      return it("requireTicket when pending ticket available", function(done) {
        return ticketManager.issue("test ticket@" + (Date.now()), "sample", {
          content: "not null"
        }, function(err, originTicket) {
          debuglog("err:" + err + ", originTicket:%j", originTicket);
          should.not.exist(err);
          should.exist(originTicket);
          ticketWorker.on("new ticket", function(ticket) {
            debuglog("on new ticket: ticket:%j", ticket);
            should.exist(ticket);
            ticket.title.should.eql(originTicket.title);
            return done();
          });
          return ticketWorker.requireTicket(function(err, ticket) {
            debuglog("requireTicket: ticket:%j", ticket);
            should.not.exist(err);
            should.exist(ticket);
            return ticket.title.should.eql(originTicket.title);
          });
        });
      });
    });
  });

}).call(this);
