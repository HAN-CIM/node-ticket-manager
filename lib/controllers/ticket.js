// Generated by CoffeeScript 1.6.3
(function() {
  var STATUS, Ticket, mongoose;

  mongoose = require('mongoose');

  Ticket = mongoose.model('Ticket');

  STATUS = require("../enums/ticket_status");

  exports.index = function(req, res, next) {
    Ticket.find().sort({
      created_at: 'desc'
    }).exec(function(err, tickets) {
      if (err != null) {
        return next(err);
      }
      res.render('tickets/index', {
        title: 'All Tickets',
        tickets: tickets
      });
    });
  };

  exports.show = function(req, res, next) {
    var id;
    id = String(req.params.id || '');
    if (id == null) {
      return next();
    }
    Ticket.findById(id, function(err, ticket) {
      if (err != null) {
        return next(err);
      }
      res.render('tickets/show', {
        title: 'All Tickets',
        ticket: ticket
      });
    });
  };

  exports.create = function(req, res, next) {
    var ticket,
      _this = this;
    ticket = new Ticket(req.body);
    ticket.save(function(err) {
      if (err != null) {
        return res.json({
          success: false,
          error: err.toString()
        });
      } else {
        return res.json({
          success: true,
          ticket: ticket
        });
      }
    });
  };

  exports.assign = function(req, res, next) {
    req.body.worker = req.worker.name;
    Ticket.arrangeAssignment(req.body, function(err, ticket) {
      if (err != null) {
        return next(err);
      }
      if (ticket == null) {
        return next();
      }
      return res.json(ticket);
    });
  };

  exports.comment = function(req, res, next) {
    var id;
    id = req.params.id || '';
    if (id == null) {
      return next();
    }
    console.log("[ticket::comment] id:" + id);
    console.dir(req.params);
    Ticket.addComment(id, req.body, function(err, ticket) {
      if (err != null) {
        return next(err);
      }
      if (ticket == null) {
        return next();
      }
      return res.json(ticket);
    });
  };

  exports.complete = function(req, res, next) {
    var id;
    id = String(req.params.id || '');
    if (id == null) {
      return next();
    }
    req.body.id = id;
    Ticket.changeStatus(req.body, STATUS.COMPLETE, function(err, ticket) {
      if (err != null) {
        return next(err);
      }
      if (ticket == null) {
        return next();
      }
      return res.json(ticket);
    });
  };

  exports.giveup = function(req, res, next) {
    var id;
    id = String(req.params.id || '');
    if (id == null) {
      return next();
    }
    req.body.id = id;
    Ticket.changeStatus(req.body, STATUS.PENDING, function(err, ticket) {
      if (err != null) {
        return next(err);
      }
      if (ticket == null) {
        return next();
      }
      ticket.update({
        $inc: {
          attempts: 1
        }
      }, function(err, numberAffected) {
        if (err != null) {
          return next(err);
        }
        ticket.attempts = numberAffected;
        return res.json(ticket);
      });
    });
  };

}).call(this);
